#playbook-bootstrap_debian.yml
---
- hosts: all
  vars:
    deploy_user_name: moof
    # specify password with --extra-vars "deploy_password=moof-password
    deploy_public_keys:
      - ../config/id_rsa-pub

    common_required_packages:
      - "@Development tools"
      - sudo
      - firewalld
      - fail2ban
      - logwatch

    common_optional_packages:
      - vim
      - htop
      - git
      - tmux

    initial_ssh_port: 22
    final_ssh_port: 22

  tasks:
    - fail: msg="Please specify deploy password with --extra-vars 'deploy_password=...'."
      when: deploy_password is undefined

    - name: Install EPEL-release to gain access to a larger set of packages
      package: state=present name=epel-release

    - name: Update yum cache
      command: yum -y update
      
    - name: Install required packages
      package: state=present name={{ item }}
      with_items: "{{ common_required_packages }}"

    - name: Install latest version of optional packages
      package: state=latest name={{ item }}
      with_items: "{{ common_optional_packages }}"

    - name: Check if pip is installed
      command: which pip
      register: pip_task_installed
      changed_when: no
      failed_when: no

    - name: Download pip installer
      get_url:
        url=https://bootstrap.pypa.io/get-pip.py
        dest="/tmp/get-pip.py"
      when: pip_task_installed is defined and pip_task_installed.rc != 0

    - name: run installer
      command: "python /tmp/get-pip.py"
      when: pip_task_installed is defined and pip_task_installed.rc != 0

    - name: Add deploy user
      user: name="{{ deploy_user_name }}" password="{{ deploy_password | password_hash('sha512') }}" shell=/bin/bash

    - name: Add authorized keys for deploy user
      authorized_key: user="{{ deploy_user_name }}" key="{{ lookup('file', item) }}"
      with_items: "{{ deploy_public_keys }}"
      
    - name: Add deploy user to sudoers
      lineinfile: dest=/etc/sudoers
                  regexp="{{ deploy_user_name }} ALL"
                  line="{{ deploy_user_name }} ALL=(ALL) ALL"
                  state=present

#    - name: Enable firewall at boot and start it
#      service: name=firewalld enabled=yes state=started
#
#    - name: Allow services  through firewall
#      command: firewall-cmd --permanent --zone=public --add-service={{ item }}
#      with_items:
#        - ssh
#      notify: 
#        - Reload firewall


#    - name: Set up Postfix to relay mail
#      debconf: name=postfix
#               question='{{ item.question }}'
#               value='{{ item.value }}'
#               vtype='{{ item.vtype }}'
#      with_items:
#        - { question: 'postfix/mailname', value: '{{ ansible_fqdn }}', vtype: 'string' }
#        - { question: 'postfix/main_mailer_type', value: 'Internet Site', vtype: 'string' }

#    - name: Email log summary daily
#      lineinfile: dest=/etc/cron.daily/00logwatch
#                  regexp="^/usr/sbin/logwatch"
#                  line="/usr/sbin/logwatch --output mail --mailto {{ COMMON_LOGWATCH_EMAIL }} --detail high"
#                  state=present create=yes

#    - name: Change ssh port
#      lineinfile: dest=/etc/ssh/sshd_config
#                  regexp="^Port\s"
#                  line="Port {{ final_ssh_port }}"
#                  state=present
#      when: final_ssh_port != initial_ssh_port
#      notify: Restart ssh

    - name: Disallow password authentication
      lineinfile: dest=/etc/ssh/sshd_config
                  regexp="^PasswordAuthentication"
                  line="PasswordAuthentication no"
                  state=present
      notify: Restart ssh

    - name: Disallow root SSH access
      lineinfile: dest=/etc/ssh/sshd_config
                  regexp="^PermitRootLogin"
                  line="PermitRootLogin no"
                  state=present
      notify: Restart ssh

  handlers:
    - name: Restart ssh
      service: name=ssh state=restarted
    - name: Restart firewall
      service: name=firewalld enabled=yes state=started
    - name: Reload firewall
      command: firewall-cmd --reload


